<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Analitik Keterlambatan Siswa</title>
    
    <!-- Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-icons@0.372.0"></script>

    <!-- Pustaka untuk PDF & Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Pustaka untuk manipulasi tanggal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/umd/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/locale/id/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousMonday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousTuesday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousWednesday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousThursday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousFriday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousSaturday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/previousSunday.min.js"></script>


    <!-- Pustaka untuk Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; /* slate-200 */ }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .chat-bubble {
            background-color: #f1f5f9; /* slate-100 */
            color: #334155; /* slate-700 */
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 70%;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease-out forwards;
        }
        .chat-bubble.user {
            background-color: #059669; /* emerald-600 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.bot {
            background-color: #e2e8f0; /* slate-200 */
            color: #334155; /* slate-700 */
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble table { width: 100%; margin-top: 12px; font-size: 0.875rem; border-collapse: collapse; }
        .chat-bubble th, .chat-bubble td { border: 1px solid #cbd5e1; padding: 8px 12px; text-align: left; }
        .chat-bubble th { background-color: #e2e8f0; font-weight: 600; }
        .chat-bubble td { background-color: #ffffff; }
        .chat-bubble .chart-container {
            width: 100%;
            height: 300px; /* Atur tinggi default untuk grafik */
            margin-top: 12px;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
        }
        .download-btn-chat {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .download-btn-chat:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .download-btn-chat.pdf { background-color: #ef4444; } /* red-500 */
        .download-btn-chat.pdf:hover { background-color: #dc2626; } /* red-600 */
        .download-btn-chat.excel { background-color: #22c55e; } /* green-500 */
        .download-btn-chat.excel:hover { background-color: #16a34a; } /* green-600 */
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Bagian Atas: Tabel Data Hari Ini -->
        <section id="today-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8 fade-in">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Data Realtime Siswa Terlambat  Hari ini</h2>
                    <p id="current-date" class="text-slate-500"></p>
                </div>
                <div id="today-download-buttons" class="flex items-center gap-3 hidden">
                    <button data-type="pdf" class="download-btn bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="file-type-pdf" class="w-4 h-4"></i> Unduh PDF
                    </button>
                    <button data-type="excel" class="download-btn bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition flex items-center gap-2 text-sm font-semibold">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Unduh Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="today-table" class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <!-- Header akan diisi oleh JS -->
                    </thead>
                    <tbody>
                        <!-- Data akan diisi oleh JS -->
                    </tbody>
                </table>
                <div id="today-loading" class="text-center py-8">
                    <i data-lucide="loader-2" class="w-8 h-8 text-emerald-500 mx-auto animate-spin"></i>
                    <p class="mt-2 text-slate-500">Memuat data hari ini...</p>
                </div>
            </div>
        </section>

        <!-- Bagian Bawah: Asisten Chat Cerdas -->
        <section id="chat-section" class="bg-white p-6 rounded-2xl shadow-lg fade-in" style="animation-delay: 0.2s;">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Asisten Chat Cerdas</h3>
            <div class="flex flex-col flex-grow bg-slate-100 p-4 rounded-lg overflow-y-auto h-96" id="chat-window">
                <!-- Pesan chat akan muncul di sini -->
            </div>
            <div class="mt-4 flex gap-2">
                <input type="text" id="search-input" placeholder="Tanya tentang data: 'minggu kemarin', 'hari Senin', 'dari tanggal 10 Juli', 'grafik bulan ini', dll." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <button id="search-btn" class="bg-emerald-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-emerald-700 transition-colors font-semibold flex items-center justify-center">
                    <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                </button>
            </div>
        </section>
    </div>

    <script>
        // --- KONFIGURASI GOOGLE SHEETS ---
        // GANTI DENGAN API KEY DAN SPREADSHEET ID ANDA
        const API_KEY = 'AIzaSyCCjeeWBHSGGIMVmtSaUadLioZGL19f_VY'; // Kosongkan jika Anda ingin Canvas menyediakan API Key secara otomatis untuk model Gemini
        const SPREADSHEET_ID = '1-1kof1L9-mCbZiYKINeSXxk_zoBNDQkDlPW5zu-VwbiEc'; // Ganti dengan ID Spreadsheet Anda
        const RANGE = 'Sheet1!A:F'; // Sesuaikan jika range data Anda berbeda

        // --- ELEMEN DOM ---
        const todayTableBody = document.querySelector('#today-table tbody');
        const todayTableHeader = document.querySelector('#today-table thead');
        const todayLoading = document.getElementById('today-loading');
        const todayDownloadButtons = document.getElementById('today-download-buttons');
        const chatWindow = document.getElementById('chat-window');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // --- GLOBAL STATE ---
        let allStudentData = [];
        let headers = [];
        const { 
            parse, format, subDays, startOfWeek, endOfWeek, startOfMonth, endOfMonth, isSameDay,
            previousMonday, previousTuesday, previousWednesday, previousThursday, previousFriday, previousSaturday, previousSunday
        } = window.dateFns;
        const idLocale = window.dateFns.locale.id; // Menggunakan locale Bahasa Indonesia

        // --- FUNGSI UTAMA ---

        /**
         * Memuat dan memproses data dari Google Sheets.
         * Menampilkan pesan error jika API Key atau Spreadsheet ID tidak dikonfigurasi.
         */
        async function loadData() {
            if (!API_KEY && typeof __app_id === 'undefined') { // Check if API_KEY is empty and __app_id is not defined
                handleError(todayLoading, "Harap konfigurasikan API Key dan Spreadsheet ID di dalam kode, atau jalankan di lingkungan Canvas.");
                return;
            }
            if (SPREADSHEET_ID.startsWith('1-I44W70L0h80_0B81w767420_0000000000000000000')) {
                 handleError(todayLoading, "Harap ganti SPREADSHEET_ID dengan ID Spreadsheet Anda.");
                 return;
            }

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                processSheetData(data.values);
                displayTodaysTable();
            } catch (error) {
                console.error('Gagal mengambil data:', error);
                handleError(todayLoading, `Gagal mengambil data: ${error.message}. Pastikan API Key dan Spreadsheet ID benar dan API Google Sheets sudah diaktifkan.`);
            }
        }

        /**
         * Mengubah data mentah dari Google Sheets menjadi array of objects.
         * Mem-parsing kolom 'Tanggal' menjadi objek Date.
         * @param {Array<Array<string>>} rows - Data mentah dari Google Sheets.
         */
        function processSheetData(rows) {
            if (!rows || rows.length < 2) {
                allStudentData = []; headers = []; return;
            }
            // Baris pertama adalah header
            headers = rows[0].map(h => h.trim());
            const dateHeader = headers.find(h => h.toLowerCase().includes('tanggal'));
            const dataRows = rows.slice(1);
            
            allStudentData = dataRows.map(row => {
                const studentObject = {};
                headers.forEach((header, index) => {
                    studentObject[header] = row[index] || '';
                });
                // PENTING: Parsing tanggal. Asumsi format di sheet adalah 'dd/MM/yyyy'.
                // Jika format berbeda, ubah di sini. Contoh: 'MM/dd/yyyy'
                if (dateHeader && studentObject[dateHeader]) {
                    try {
                        studentObject.dateObject = parse(studentObject[dateHeader], 'dd/MM/yyyy', new Date());
                    } catch (e) {
                        studentObject.dateObject = null; // Tanggal tidak valid
                        console.warn(`Gagal parsing tanggal '${studentObject[dateHeader]}': ${e.message}`);
                    }
                }
                return studentObject;
            }).filter(s => s.dateObject); // Hanya simpan data dengan tanggal yang valid
        }

        /**
         * Menampilkan data keterlambatan hari ini di tabel utama.
         */
        function displayTodaysTable() {
            const today = new Date();
            const todayData = allStudentData.filter(d => isSameDay(d.dateObject, today));
            
            todayLoading.style.display = 'none';
            todayTableHeader.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>`;
            
            if (todayData.length === 0) {
                todayTableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-6">Tidak ada data keterlambatan hari ini.</td></tr>`;
                todayDownloadButtons.classList.add('hidden');
            } else {
                todayTableBody.innerHTML = todayData.map(row => `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        ${headers.map(h => `<td class="px-6 py-4">${row[h]}</td>`).join('')}
                    </tr>
                `).join('');
                todayDownloadButtons.classList.remove('hidden');
            }
        }

        // --- FUNGSI ASISTEN CHAT CERDAS (INTEGRASI LLM) ---

        /**
         * Mengirim query pengguna ke LLM dan memproses responsnya.
         */
        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            addChatMessage('user', query);
            searchInput.value = '';
            const botThinkingMessage = addChatMessage('bot', `<i data-lucide="loader-2" class="w-5 h-5 inline-block animate-spin mr-2"></i> Memproses permintaan Anda...`);
            lucide.createIcons(); // Render loader icon

            try {
                // Prompt untuk LLM
                const prompt = `Anda adalah asisten data untuk dasbor keterlambatan siswa. Data yang tersedia memiliki header berikut: ${JSON.stringify(headers)}.
                Tugas Anda adalah memahami pertanyaan pengguna dan memberikan instruksi dalam format JSON untuk memfilter data atau membuat grafik.
                Tanggal harus dalam format 'YYYY-MM-DD'.

                Format JSON yang diharapkan:
                {
                    "action": "query_data" | "chart_data" | "general_response",
                    "relativePeriod": "today" | "yesterday" | "last_week" | "this_month" | "all_data" | "last_monday" | "last_tuesday" | "last_wednesday" | "last_thursday" | "last_friday" | "last_saturday" | "last_sunday" | null,
                    "startDate": "YYYY-MM-DD" | null,
                    "endDate": "YYYY-MM-DD" | null,
                    "filters": {"[nama_kolom]": "[nilai_filter]"} | null,
                    "chartType": "bar" | "pie" | "line" | null,
                    "chartDimension": "[nama_kolom]" | null,
                    "message": "Pesan respons jika action adalah general_response" | null
                }

                Prioritas:
                1. Jika ada tanggal spesifik (misal: "dari tanggal X", "sampai tanggal Y", "antara X dan Y"), gunakan "startDate" dan/atau "endDate".
                2. Jika ada periode relatif (misal: "kemarin", "minggu lalu", "hari Senin"), gunakan "relativePeriod".
                3. Jika ada filter spesifik (misal: "nama Budi", "kelas A"), gunakan "filters".
                4. Jika ada permintaan grafik, gunakan "chartType" dan "chartDimension".

                Contoh:
                - User: "data keterlambatan minggu lalu"
                  Output: {"action": "query_data", "relativePeriod": "last_week", "startDate": null, "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "grafik keterlambatan per kelas bulan ini"
                  Output: {"action": "chart_data", "relativePeriod": "this_month", "startDate": null, "endDate": null, "filters": null, "chartType": "bar", "chartDimension": "Kelas", "message": null}
                - User: "berapa siswa yang terlambat hari ini"
                  Output: {"action": "query_data", "relativePeriod": "today", "startDate": null, "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "cari siswa bernama Budi"
                  Output: {"action": "query_data", "relativePeriod": null, "startDate": null, "endDate": null, "filters": {"Nama": "Budi"}, "chartType": null, "chartDimension": null, "message": null}
                - User: "data hari Senin"
                  Output: {"action": "query_data", "relativePeriod": "last_monday", "startDate": null, "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "data dari tanggal 10 Juli 2024 dan seterusnya"
                  Output: {"action": "query_data", "relativePeriod": null, "startDate": "2024-07-10", "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "data dari bulan Januari 2024 dan seterusnya"
                  Output: {"action": "query_data", "relativePeriod": null, "startDate": "2024-01-01", "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "data sampai tanggal 15 Maret 2024"
                  Output: {"action": "query_data", "relativePeriod": null, "startDate": null, "endDate": "2024-03-15", "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "data antara 1 Januari 2024 dan 31 Januari 2024"
                  Output: {"action": "query_data", "relativePeriod": null, "startDate": "2024-01-01", "endDate": "2024-01-31", "filters": null, "chartType": null, "chartDimension": null, "message": null}
                - User: "halo"
                  Output: {"action": "general_response", "relativePeriod": null, "startDate": null, "endDate": null, "filters": null, "chartType": null, "chartDimension": null, "message": "Halo! Ada yang bisa saya bantu terkait data keterlambatan siswa?"}
                
                Pastikan semua string dalam JSON menggunakan double quotes.
                Pertanyaan pengguna: "${query}"
                `;

                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "action": { "type": "STRING" },
                                "relativePeriod": { "type": "STRING", "nullable": true },
                                "startDate": { "type": "STRING", "nullable": true },
                                "endDate": { "type": "STRING", "nullable": true },
                                "filters": { "type": "OBJECT", "nullable": true },
                                "chartType": { "type": "STRING", "nullable": true },
                                "chartDimension": { "type": "STRING", "nullable": true },
                                "message": { "type": "STRING", "nullable": true }
                            },
                            "propertyOrdering": ["action", "relativePeriod", "startDate", "endDate", "filters", "chartType", "chartDimension", "message"]
                        }
                    }
                };
                
                const apiKey = API_KEY; // If API_KEY is empty, Canvas will provide it
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                // Hapus pesan "Memproses..."
                chatWindow.removeChild(botThinkingMessage);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    console.log("LLM Response:", jsonResponse); // For debugging

                    let filteredData = [];
                    let title = "Hasil Pencarian";

                    // Dapatkan rentang tanggal dari LLM
                    const dateRangeParams = {
                        relativePeriod: jsonResponse.relativePeriod,
                        startDate: jsonResponse.startDate,
                        endDate: jsonResponse.endDate
                    };
                    const dateRange = getDateRange(dateRangeParams);

                    if (dateRange && dateRange.start && dateRange.end) {
                        filteredData = allStudentData.filter(d => 
                            d.dateObject && d.dateObject >= dateRange.start && d.dateObject <= dateRange.end
                        );
                        title = dateRange.title;
                    } else {
                        filteredData = allStudentData; // Default ke semua data jika periode tidak dikenali atau tidak valid
                        title = "Semua Data Keterlambatan";
                    }

                    // Filter data berdasarkan filter spesifik (nama/kelas)
                    if (jsonResponse.filters) {
                        for (const key in jsonResponse.filters) {
                            const filterValue = String(jsonResponse.filters[key]).toLowerCase();
                            const headerKey = headers.find(h => h.toLowerCase() === key.toLowerCase()); // Temukan header yang cocok (case-insensitive)
                            if (headerKey) {
                                filteredData = filteredData.filter(d => 
                                    String(d[headerKey]).toLowerCase().includes(filterValue)
                                );
                            }
                        }
                        if (Object.keys(jsonResponse.filters).length > 0) {
                             title += ` (Filter: ${Object.entries(jsonResponse.filters).map(([k,v]) => `${k}: ${v}`).join(', ')})`;
                        }
                    }

                    // Tampilkan hasil berdasarkan action dari LLM
                    if (jsonResponse.action === 'query_data') {
                        displayResultsInChat(filteredData, title);
                    } else if (jsonResponse.action === 'chart_data' && jsonResponse.chartType && jsonResponse.chartDimension) {
                        displayChartInChat(filteredData, jsonResponse.chartType, jsonResponse.chartDimension, title);
                    } else if (jsonResponse.action === 'general_response' && jsonResponse.message) {
                        addChatMessage('bot', jsonResponse.message);
                    } else {
                        addChatMessage('bot', "Maaf, saya tidak dapat memproses permintaan Anda. Coba formulasi ulang atau tanyakan hal lain.");
                    }

                } else {
                    addChatMessage('bot', "Maaf, terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.");
                }

            } catch (error) {
                console.error('Error fetching from LLM:', error);
                // Hapus pesan "Memproses..." jika masih ada
                if (chatWindow.contains(botThinkingMessage)) {
                    chatWindow.removeChild(botThinkingMessage);
                }
                addChatMessage('bot', `Maaf, terjadi kesalahan teknis: ${error.message}.`);
            }
        }

        /**
         * Mendapatkan rentang tanggal berdasarkan parameter dari LLM.
         * @param {{relativePeriod?: string, startDate?: string, endDate?: string}} params - Parameter rentang tanggal.
         * @returns {{start: Date, end: Date, title: string}|null} Objek rentang tanggal.
         */
        function getDateRange(params) {
            const now = new Date();
            let start = null;
            let end = null;
            let title = "Laporan Keterlambatan";

            // Prioritize explicit start/end dates from LLM
            if (params.startDate && params.endDate) {
                start = parse(params.startDate, 'yyyy-MM-dd', now);
                end = parse(params.endDate, 'yyyy-MM-dd', now);
                title = `Laporan Keterlambatan (${format(start, 'd MMMM yyyy', { locale: idLocale })} - ${format(end, 'd MMMM yyyy', { locale: idLocale })})`;
            } else if (params.startDate) {
                start = parse(params.startDate, 'yyyy-MM-dd', now);
                end = now; // "dan seterusnya" implies until today
                title = `Laporan Keterlambatan dari ${format(start, 'd MMMM yyyy', { locale: idLocale })}`;
            } else if (params.endDate) { // "sampai tanggal Y"
                start = new Date(0); // From beginning of time (or a very early date)
                end = parse(params.endDate, 'yyyy-MM-dd', now);
                title = `Laporan Keterlambatan hingga ${format(end, 'd MMMM yyyy', { locale: idLocale })}`;
            } else if (params.relativePeriod) {
                switch (params.relativePeriod) {
                    case 'today':
                        start = end = now;
                        title = `Laporan Keterlambatan - ${format(now, 'd MMMM yyyy', { locale: idLocale })}`;
                        break;
                    case 'yesterday':
                        const yesterday = subDays(now, 1);
                        start = end = yesterday;
                        title = `Laporan Keterlambatan - ${format(yesterday, 'd MMMM yyyy', { locale: idLocale })}`;
                        break;
                    case 'last_week':
                        start = startOfWeek(subDays(now, 7), { weekStartsOn: 1 }); // Senin sebagai awal minggu
                        end = endOfWeek(subDays(now, 7), { weekStartsOn: 1 });
                        title = `Laporan Keterlambatan Mingguan (${format(start, 'd MMM', { locale: idLocale })} - ${format(end, 'd MMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'this_month':
                        start = startOfMonth(now);
                        end = endOfMonth(now);
                        title = `Laporan Keterlambatan Bulanan - ${format(now, 'MMMM yyyy', { locale: idLocale })}`;
                        break;
                    case 'all_data':
                        start = new Date(0); // Epoch time
                        end = now;
                        title = `Semua Data Keterlambatan`;
                        break;
                    case 'last_monday':
                        start = previousMonday(now);
                        end = start; // Only for that day
                        title = `Laporan Keterlambatan - Senin (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_tuesday':
                        start = previousTuesday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Selasa (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_wednesday':
                        start = previousWednesday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Rabu (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_thursday':
                        start = previousThursday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Kamis (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_friday':
                        start = previousFriday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Jumat (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_saturday':
                        start = previousSaturday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Sabtu (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    case 'last_sunday':
                        start = previousSunday(now);
                        end = start;
                        title = `Laporan Keterlambatan - Minggu (${format(start, 'd MMMM yyyy', { locale: idLocale })})`;
                        break;
                    default:
                        // If relativePeriod is not recognized, default to all data or null
                        start = new Date(0);
                        end = now;
                        title = `Semua Data Keterlambatan`;
                        break;
                }
            } else {
                // If no specific date or relative period, return null or default to all data
                // For now, default to all data if no valid range is determined
                start = new Date(0);
                end = now;
                title = `Semua Data Keterlambatan`;
            }

            if (start && end) {
                // Normalize start and end to start/end of day to ensure full day is included
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
            }

            return { start, end, title };
        }

        /**
         * Menampilkan hasil data dalam format tabel di jendela chat.
         * @param {Array<Object>} results - Data yang akan ditampilkan.
         * @param {string} title - Judul laporan.
         */
        function displayResultsInChat(results, title) {
            let content;
            if (results.length === 0) {
                content = `<p>Tidak ditemukan data untuk periode/filter: <strong>${title.replace('Laporan Keterlambatan - ', '')}</strong></p>`;
            } else {
                const tableHTML = `
                    <p>Ditemukan ${results.length} data untuk <strong>${title.replace('Laporan Keterlambatan - ', '')}</strong>:</p>
                    <div class="overflow-x-auto">
                        <table>
                            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${results.map(row => `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button data-type="pdf" class="download-btn-chat pdf">Unduh PDF</button>
                        <button data-type="excel" class="download-btn-chat excel">Unduh Excel</button>
                    </div>
                `;
                content = tableHTML;
            }
            const bubble = addChatMessage('bot chat-bubble', content);
            // Tambahkan event listener ke tombol download yang baru dibuat di dalam chat
            bubble.querySelectorAll('.download-btn-chat').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    if (type === 'pdf') generatePDF(results, title);
                    if (type === 'excel') generateExcel(results, title);
                });
            });
        }

        /**
         * Menampilkan grafik di jendela chat.
         * @param {Array<Object>} data - Data mentah untuk grafik.
         * @param {string} chartType - Tipe grafik ('bar', 'pie', 'line').
         * @param {string} chartDimension - Dimensi untuk mengelompokkan data (e.g., 'Kelas', 'Nama').
         * @param {string} title - Judul grafik.
         */
        function displayChartInChat(data, chartType, chartDimension, title) {
            if (!headers.includes(chartDimension)) {
                addChatMessage('bot', `Maaf, dimensi "${chartDimension}" tidak ditemukan di data. Mohon gunakan salah satu dari: ${headers.join(', ')}.`);
                return;
            }

            // Agregasi data
            const aggregatedData = {};
            data.forEach(row => {
                const dimensionValue = row[chartDimension] || 'Tidak Diketahui';
                aggregatedData[dimensionValue] = (aggregatedData[dimensionValue] || 0) + 1;
            });

            const labels = Object.keys(aggregatedData);
            const values = Object.values(aggregatedData);

            if (labels.length === 0) {
                addChatMessage('bot', `Tidak ada data yang cukup untuk membuat grafik ${chartType} berdasarkan ${chartDimension} untuk periode ini.`);
                return;
            }

            const chartId = `chart-${Date.now()}`;
            const content = `
                <p>Berikut adalah grafik <strong>${chartType}</strong> keterlambatan berdasarkan <strong>${chartDimension}</strong> untuk <strong>${title.replace('Laporan Keterlambatan - ', '')}</strong>:</p>
                <div class="chart-container">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
            const bubble = addChatMessage('bot chat-bubble', content);

            // Pastikan canvas sudah ada di DOM sebelum inisialisasi Chart.js
            setTimeout(() => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `Jumlah Keterlambatan per ${chartDimension}`,
                                data: values,
                                backgroundColor: chartType === 'pie' ? [
                                    'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
                                    'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
                                    'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(255, 99, 255, 0.8)'
                                ] : 'rgba(5, 150, 105, 0.8)', // emerald-600
                                borderColor: chartType === 'pie' ? [
                                    'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                                    'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)', 'rgba(255, 99, 255, 1)'
                                ] : 'rgba(5, 150, 105, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: chartType === 'pie' || labels.length > 5, // Tampilkan legend untuk pie atau jika banyak label
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `Keterlambatan per ${chartDimension} (${title.replace('Laporan Keterlambatan - ', '')})`,
                                    font: {
                                        size: 16
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: chartType !== 'pie' // Sembunyikan sumbu Y untuk pie chart
                                },
                                x: {
                                    display: chartType !== 'pie' // Sembunyikan sumbu X untuk pie chart
                                }
                            }
                        }
                    });
                }
            }, 100); // Sedikit delay untuk memastikan DOM dirender
        }

        // --- FUNGSI UNDUH (PDF & EXCEL) ---

        /**
         * Menghasilkan file PDF dari data tabel.
         * @param {Array<Object>} data - Data yang akan diunduh.
         * @param {string} reportTitle - Judul laporan untuk PDF.
         */
        function generatePDF(data, reportTitle) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const downloadDate = format(new Date(), 'd MMMM yyyy, HH:mm', { locale: idLocale });
            
            doc.setFontSize(18);
            doc.text(reportTitle, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Dibuat pada: ${downloadDate}`, 14, 30);

            const tableData = data.map(row => headers.map(h => row[h]));
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [5, 150, 105] }, // emerald-600
                styles: { font: 'Inter', fontStyle: 'normal' },
                didDrawPage: function (data) {
                    // Footer
                    let str = "Halaman " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            doc.save(`${reportTitle.replace(/ /g, '_')}_${format(new Date(), 'yyyyMMdd_HHmm')}.pdf`);
        }

        /**
         * Menghasilkan file Excel dari data tabel.
         * @param {Array<Object>} data - Data yang akan diunduh.
         * @param {string} reportTitle - Judul laporan untuk Excel.
         */
        function generateExcel(data, reportTitle) {
            const downloadDate = format(new Date(), 'd MMMM yyyy, HH:mm', { locale: idLocale });
            
            // Buat worksheet dari data
            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            
            // Tambahkan kop (judul laporan dan tanggal unduh) di atas data
            XLSX.utils.sheet_add_aoa(ws, [[reportTitle]], { origin: 'A1' });
            XLSX.utils.sheet_add_aoa(ws, [[`Dibuat pada: ${downloadDate}`]], { origin: 'A2' });

            // Sesuaikan range data agar dimulai setelah kop
            const originalRange = XLSX.utils.decode_range(ws['!ref']);
            const newRange = {
                s: { r: originalRange.s.r + 2, c: originalRange.s.c },
                e: { r: originalRange.e.r + 2, c: originalRange.e.c }
            };
            ws['!ref'] = XLSX.utils.encode_range(newRange);

            // Pindahkan data ke posisi baru (baris 3)
            const newData = {};
            for (const cellAddress in ws) {
                if (cellAddress.startsWith('!')) continue;
                const cell = XLSX.utils.decode_cell(cellAddress);
                if (cell.r >= originalRange.s.r) {
                    const newCellAddress = XLSX.utils.encode_cell({ r: cell.r + 2, c: cell.c });
                    newData[newCellAddress] = ws[cellAddress];
                }
            }
            // Tambahkan header lama ke baris 3
            headers.forEach((h, i) => {
                const cellAddress = XLSX.utils.encode_cell({ r: 2, c: i });
                newData[cellAddress] = { v: h, t: 's' };
            });

            // Ganti ws dengan newData
            for (const key in ws) { delete ws[key]; }
            Object.assign(ws, newData);
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Keterlambatan");
            XLSX.writeFile(wb, `${reportTitle.replace(/ /g, '_')}_${format(new Date(), 'yyyyMMdd_HHmm')}.xlsx`);
        }
        
        // --- HELPER & EVENT LISTENERS ---

        /**
         * Menambahkan pesan ke jendela chat.
         * @param {string} type - Tipe pesan ('user' atau 'bot' atau 'bot chat-bubble').
         * @param {string} message - Konten pesan (bisa HTML).
         * @returns {HTMLElement} Elemen div pesan yang baru dibuat.
         */
        function addChatMessage(type, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg max-w-xl mb-2 fade-in ${type.includes('user') ? 'bg-emerald-600 text-white ml-auto' : 'bg-slate-200 text-slate-800 mr-auto'}`;
            if (type.includes('chat-bubble')) messageDiv.classList.add('chat-bubble');
            messageDiv.innerHTML = message;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }

        /**
         * Menampilkan pesan kesalahan di elemen tertentu.
         * @param {HTMLElement} element - Elemen DOM untuk menampilkan pesan.
         * @param {string} message - Pesan kesalahan.
         */
        function handleError(element, message) {
            element.innerHTML = `<div class="text-center py-6 text-red-600">${message}</div>`;
        }
        
        // Event listener untuk tombol download di tabel atas
        document.querySelectorAll('#today-download-buttons .download-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.type;
                const today = new Date();
                const todayData = allStudentData.filter(d => isSameDay(d.dateObject, today));
                const title = `Laporan Keterlambatan - ${format(today, 'd MMMM yyyy', { locale: idLocale })}`;
                if (type === 'pdf') generatePDF(todayData, title);
                if (type === 'excel') generateExcel(todayData, title);
            });
        });

        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });

        // Inisialisasi saat window dimuat
        window.addEventListener('load', () => {
            document.getElementById('current-date').textContent = format(new Date(), 'EEEE, d MMMM yyyy', { locale: idLocale });
            loadData();
            addChatMessage('bot', "Halo! Saya Asisten Data Anda. Saya bisa membantu Anda menganalisis data keterlambatan siswa. Coba tanyakan: <strong>'data keterlambatan minggu lalu'</strong>, <strong>'hari Senin'</strong>, <strong>'dari tanggal 10 Juli 2024'</strong>, <strong>'grafik keterlambatan per kelas bulan ini'</strong>, atau <strong>'berapa siswa yang terlambat hari ini'</strong>.");
            lucide.createIcons(); // Render semua ikon Lucide
        });
    </script>
</body>
</html>
