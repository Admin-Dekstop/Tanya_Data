<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Interaktif - Data Keterlambatan Siswa</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar for chat */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #e2e8f0; /* slate-200 */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .summary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">Dasbor Keterlambatan Siswa</h1>
            <p id="current-date" class="text-lg text-slate-500 mt-2"></p>
        </header>

        <!-- Summary Cards for Today's Data -->
        <div id="summary-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Card 1: Total Terlambat Hari Ini -->
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div class="flex items-center">
                    <div class="p-3 bg-red-100 rounded-full mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Total Terlambat Hari Ini</p>
                        <p id="total-today" class="text-2xl font-bold text-slate-800">Memuat...</p>
                    </div>
                </div>
            </div>
            <!-- Card 2: Siswa Terlambat Pertama -->
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Siswa Terlambat Pertama</p>
                        <p id="first-late" class="text-xl font-bold text-slate-800">Memuat...</p>
                    </div>
                </div>
            </div>
            <!-- Card 3: Siswa Terlambat Terakhir -->
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-full mr-4">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422A12.083 12.083 0 0121 12c0 6.627-5.373 12-12 12S-3 18.627-3 12a12.083 12.083 0 014.84-7.422L12 14z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Siswa Terlambat Terakhir</p>
                        <p id="last-late" class="text-xl font-bold text-slate-800">Memuat...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Table and Chat -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Data Table Section (takes 2/3 width on large screens) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800">ðŸ“š Detail Data Keterlambatan</h2>
                    <button id="download-pdf" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Unduh PDF
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600" id="data-table">
                        <thead class="text-xs text-white uppercase bg-blue-600">
                            <!-- Headers will be populated by JS -->
                        </thead>
                        <tbody>
                            <!-- Data rows will be populated by JS -->
                            <tr><td colspan="6" class="text-center p-8">
                                <div class="flex justify-center items-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    Memuat data dari Google Sheets...
                                </div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chat Section (takes 1/3 width on large screens) -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col h-[600px] lg:h-auto">
                <div class="p-4 border-b border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800">ðŸ¤– Asisten Data</h2>
                    <p class="text-sm text-slate-500">Tanya untuk memfilter data</p>
                </div>
                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto">
                    <!-- Chat messages will be appended here -->
                    <div class="flex justify-start mb-4">
                        <div class="bg-slate-200 text-slate-800 p-3 rounded-lg max-w-xs">
                            <p>Halo! Saya bisa bantu Anda mencari data. Coba tanya seperti: <br><em>"Tampilkan data kelas 10 TKJ 1"</em> atau <em>"Siapa saja yang terlambat tanggal 20 Juli 2024?"</em></p>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-200">
                    <div class="flex items-center">
                        <input type="text" id="chat-input" class="flex-grow border border-slate-300 rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ketik pesan Anda...">
                        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-r-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- KONFIGURASI ---
        // GANTI DENGAN API KEY DAN SPREADSHEET ID ANDA
        const API_KEY = 'AIzaSyCCjeeWBHSGGIMVmtSaUadLioZGL19f_VY'; 
        const SPREADSHEET_ID = '1kof1L9-mCbZiYKINeSXxk_zoBNDQkDlPW5zu-VwbiEc';
        const RANGE = 'Sheet1!A:F'; // Kolom: NAMA, KELAS, HARI, JAM, TANGGAL, ALASAN LAMBAT

        // --- DOM ELEMENTS ---
        const tableHead = document.querySelector('#data-table thead');
        const tableBody = document.querySelector('#data-table tbody');
        const downloadPdfButton = document.getElementById('download-pdf');
        const currentDateEl = document.getElementById('current-date');
        const totalTodayEl = document.getElementById('total-today');
        const firstLateEl = document.getElementById('first-late');
        const lastLateEl = document.getElementById('last-late');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // --- GLOBAL STATE ---
        let allStudentData = [];
        let currentHeaders = [];
        let headerIndexMap = {};

        // --- UTILITY FUNCTIONS ---
        /**
         * Formats a Date object into DD/MM/YYYY string
         * @param {Date} date The date to format
         * @returns {string} Formatted date string
         */
        const formatDate = (date) => {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };

        // --- DATA FETCHING AND RENDERING ---

        /**
         * Fetches data from Google Sheets API
         */
        async function fetchSheetData() {
            if (API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY' || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID') {
                showErrorInTable('Harap masukkan API Key dan Spreadsheet ID Anda di dalam kode.');
                showErrorInChat('Konfigurasi belum selesai. Harap masukkan API Key dan Spreadsheet ID pada kode.');
                return;
            }

            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'Gagal mengambil data dari Google Sheets.');
                }
                const data = await response.json();
                const rows = data.values;

                if (!rows || rows.length < 2) {
                    showErrorInTable('Tidak ada data yang ditemukan di spreadsheet.');
                    return;
                }

                currentHeaders = rows[0];
                allStudentData = rows.slice(1);
                
                // Create a map of header names to their index for easy lookup
                headerIndexMap = currentHeaders.reduce((acc, header, index) => {
                    acc[header.toLowerCase()] = index;
                    return acc;
                }, {});

                renderTable(allStudentData, currentHeaders);
                displayTodaysSummary(allStudentData, currentHeaders);

            } catch (error) {
                console.error('Error fetching data:', error);
                showErrorInTable(`Gagal mengambil data: ${error.message}`);
                showErrorInChat(`Terjadi kesalahan saat mengambil data. Silakan periksa konsol untuk detail.`);
            }
        }

        /**
         * Renders data into the HTML table
         * @param {Array<Array<string>>} dataRows The data to render
         * @param {Array<string>} headers The table headers
         */
        function renderTable(dataRows, headers) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // Render header
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Render body
            if (dataRows.length === 0) {
                showErrorInTable('Tidak ada data yang cocok dengan kriteria pencarian Anda.');
                return;
            }

            dataRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-slate-50';
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4';
                    // Make the first column (usually name) bold
                    if (index === 0) {
                        td.className += ' font-medium text-slate-900';
                    }
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        /**
         * Displays a message in the table body
         * @param {string} message The message to display
         */
        function showErrorInTable(message) {
            tableBody.innerHTML = `<tr><td colspan="${currentHeaders.length || 6}" class="text-center p-8 text-red-500">${message}</td></tr>`;
        }

        /**
         * Updates the summary cards with today's data
         * @param {Array<Array<string>>} rows All student data
         * @param {Array<string>} headers The table headers
         */
        function displayTodaysSummary(rows, headers) {
            const todayStr = formatDate(new Date());
            currentDateEl.textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const dateIndex = headerIndexMap['tanggal'];
            const nameIndex = headerIndexMap['nama'];
            const timeIndex = headerIndexMap['jam'];

            if (dateIndex === undefined || nameIndex === undefined || timeIndex === undefined) {
                totalTodayEl.textContent = 'N/A';
                firstLateEl.textContent = 'N/A';
                lastLateEl.textContent = 'N/A';
                console.error("Kolom 'TANGGAL', 'NAMA', atau 'JAM' tidak ditemukan di header spreadsheet.");
                return;
            }

            const todaysData = rows.filter(row => row[dateIndex] === todayStr);

            totalTodayEl.textContent = todaysData.length;

            if (todaysData.length > 0) {
                // Sort by time to find first and last
                todaysData.sort((a, b) => a[timeIndex].localeCompare(b[timeIndex]));
                firstLateEl.textContent = `${todaysData[0][nameIndex]} (${todaysData[0][timeIndex]})`;
                lastLateEl.textContent = `${todaysData[todaysData.length - 1][nameIndex]} (${todaysData[todaysData.length - 1][timeIndex]})`;
            } else {
                firstLateEl.textContent = 'Tidak ada';
                lastLateEl.textContent = 'Tidak ada';
            }
        }

        // --- CHAT FUNCTIONALITY ---

        /**
         * Handles the chat submission process
         */
        async function handleChatSubmit() {
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            chatInput.value = '';
            addChatMessage('Sedang berpikir...', 'bot', true);

            try {
                const filters = await getFiltersFromAI(userInput);
                filterAndDisplayData(filters);
                
                const botResponse = filters ? `Baik, saya telah memfilter data berdasarkan permintaan Anda.` : `Saya menampilkan kembali semua data.`;
                updateLastBotMessage(botResponse);

            } catch (error) {
                console.error('AI Error:', error);
                updateLastBotMessage('Maaf, saya kesulitan memahami permintaan Anda. Coba gunakan kata kunci yang lebih spesifik.');
            }
        }
        
        /**
         * Uses Gemini API to get structured filters from natural language
         * @param {string} prompt The user's input text
         * @returns {Promise<Object|null>} A promise that resolves to a filter object or null
         */
        async function getFiltersFromAI(prompt) {
            // If the user asks to reset, return null to show all data
            if (prompt.toLowerCase().includes('semua data') || prompt.toLowerCase().includes('reset')) {
                return null;
            }
            
            const systemPrompt = `Anda adalah asisten cerdas untuk sistem data keterlambatan siswa. Tugas Anda adalah menganalisis permintaan pengguna dan mengubahnya menjadi objek filter JSON. Kolom yang tersedia adalah NAMA, KELAS, dan TANGGAL. Jika pengguna menyebutkan hari seperti 'kemarin' atau 'hari ini', ubah menjadi format tanggal DD/MM/YYYY. Tanggal hari ini adalah ${formatDate(new Date())}. Balas HANYA dengan objek JSON.`;

            const schema = {
                type: "OBJECT",
                properties: {
                    "nama": { "type": "STRING", "description": "Nama siswa" },
                    "kelas": { "type": "STRING", "description": "Kelas siswa" },
                    "tanggal": { "type": "STRING", "description": "Tanggal keterlambatan dalam format DD/MM/YYYY" }
                }
            };

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: `${systemPrompt}\n\nPermintaan Pengguna: "${prompt}"` }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            
            const apiKey = ""; // Leave blank, will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                 const jsonText = result.candidates[0].content.parts[0].text;
                 return JSON.parse(jsonText);
            } else {
                 throw new Error("No valid response from AI.");
            }
        }

        /**
         * Filters the main data based on the AI-generated filters and re-renders the table
         * @param {Object|null} filters The filter object from the AI
         */
        function filterAndDisplayData(filters) {
            if (!filters) {
                renderTable(allStudentData, currentHeaders); // Show all data if filters are null
                return;
            }

            let filteredData = [...allStudentData];
            const nameIndex = headerIndexMap['nama'];
            const classIndex = headerIndexMap['kelas'];
            const dateIndex = headerIndexMap['tanggal'];

            if (filters.nama && nameIndex !== undefined) {
                filteredData = filteredData.filter(row => row[nameIndex].toLowerCase().includes(filters.nama.toLowerCase()));
            }
            if (filters.kelas && classIndex !== undefined) {
                filteredData = filteredData.filter(row => row[classIndex].toLowerCase().includes(filters.kelas.toLowerCase()));
            }
            if (filters.tanggal && dateIndex !== undefined) {
                filteredData = filteredData.filter(row => row[dateIndex] === filters.tanggal);
            }

            renderTable(filteredData, currentHeaders);
        }

        /**
         * Adds a message to the chat window
         * @param {string} text The message content
         * @param {'user'|'bot'} sender The sender of the message
         * @param {boolean} [isThinking=false] Whether this is a 'thinking' message
         */
        function addChatMessage(text, sender, isThinking = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-lg max-w-xs ${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-800'}`;
            
            if (isThinking) {
                messageBubble.id = 'thinking-bubble';
                messageBubble.innerHTML = `<div class="flex items-center"><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce mr-1"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce delay-75 mr-1"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce delay-150"></div></div>`;
            } else {
                messageBubble.textContent = text;
            }

            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }
        
        /**
         * Updates the last bot message (typically the 'thinking' one)
         * @param {string} newText The new text for the message
         */
        function updateLastBotMessage(newText) {
            const thinkingBubble = document.getElementById('thinking-bubble');
            if (thinkingBubble) {
                thinkingBubble.innerHTML = ''; // Clear thinking dots
                thinkingBubble.textContent = newText;
                thinkingBubble.id = '';
            }
        }
        
        /**
         * Displays an error message in the chat window
         * @param {string} message The error message
         */
        function showErrorInChat(message) {
            addChatMessage(message, 'bot');
        }

        // --- PDF DOWNLOAD ---

        /**
         * Generates and downloads a PDF of the currently displayed table data
         */
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const tableRows = [];
            tableBody.querySelectorAll('tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach(td => {
                    rowData.push(td.textContent);
                });
                tableRows.push(rowData);
            });
            
            if (tableRows.length === 0 || (tableRows.length === 1 && tableRows[0].length === 1)) {
                alert("Tidak ada data untuk diunduh.");
                return;
            }

            doc.autoTable({
                head: [currentHeaders],
                body: tableRows,
                startY: 20,
                theme: 'grid',
                headStyles: { fillColor: [22, 101, 216] }, // Blue-600
                didDrawPage: function (data) {
                    // Header
                    doc.setFontSize(20);
                    doc.setTextColor(40);
                    doc.text("Laporan Keterlambatan Siswa", data.settings.margin.left, 15);
                },
            });

            doc.save(`Laporan_Keterlambatan_${formatDate(new Date())}.pdf`);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', fetchSheetData);
        downloadPdfButton.addEventListener('click', downloadPDF);
        sendButton.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChatSubmit();
            }
        });

    </script>
</body>
</html>
