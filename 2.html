<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Analitik Cerdas - Keterlambatan Siswa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .nav-link.active {
            background-color: #334155; /* slate-700 */
            color: #f8fafc; /* slate-50 */
            font-weight: 600;
        }
        .skeleton-loader {
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
        }
        /* Custom scrollbar for chat */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="flex h-screen bg-slate-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-800 text-slate-300 flex flex-col">
            <div class="h-20 flex items-center justify-center border-b border-slate-700">
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="bar-chart-3"></i>
                    Analitik Siswa
                </h1>
            </div>
            <nav class="flex-grow px-4 py-6">
                <a href="#" id="nav-summary" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Ringkasan</span>
                </a>
                <a href="#" id="nav-data" class="nav-link flex items-center gap-3 px-4 py-3 mt-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i data-lucide="database"></i>
                    <span>Data & AI</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-700">
                 <button id="download-pdf" title="Unduh Laporan PDF" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform hover:scale-105">
                    <i data-lucide="file-down"></i>
                    <span>Unduh Laporan</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Dasbor Analitik Keterlambatan</h2>
                    <p id="current-date" class="text-sm text-slate-500 flex items-center gap-2 mt-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <span>Memuat tanggal...</span>
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="search-input" placeholder="Cari siswa..." class="pl-10 pr-4 py-2 w-64 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto p-8">
                <!-- Summary Content -->
                <div id="content-summary">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <!-- Chart 1: Lateness by Class -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg shadow-slate-200/50">
                            <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="users" class="text-blue-500"></i> Keterlambatan per Kelas (Bulan Ini)</h3>
                            <div id="chart-by-class-container" class="h-80">
                                <div class="skeleton-loader w-full h-full animate-pulse"></div>
                            </div>
                        </div>
                        <!-- Leaderboard -->
                        <div class="bg-white p-6 rounded-xl shadow-lg shadow-slate-200/50">
                            <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="trophy" class="text-amber-500"></i> Paling Sering Terlambat</h3>
                            <div id="leaderboard-container">
                                <!-- Skeleton loaders for leaderboard -->
                                <div class="space-y-4">
                                    <div class="flex items-center space-x-3"><div class="skeleton-loader h-10 w-10 rounded-full animate-pulse"></div><div class="flex-1 space-y-2"><div class="skeleton-loader h-4 w-3/4 animate-pulse"></div><div class="skeleton-loader h-3 w-1/2 animate-pulse"></div></div></div>
                                    <div class="flex items-center space-x-3"><div class="skeleton-loader h-10 w-10 rounded-full animate-pulse"></div><div class="flex-1 space-y-2"><div class="skeleton-loader h-4 w-3/4 animate-pulse"></div><div class="skeleton-loader h-3 w-1/2 animate-pulse"></div></div></div>
                                    <div class="flex items-center space-x-3"><div class="skeleton-loader h-10 w-10 rounded-full animate-pulse"></div><div class="flex-1 space-y-2"><div class="skeleton-loader h-4 w-3/4 animate-pulse"></div><div class="skeleton-loader h-3 w-1/2 animate-pulse"></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-8">
                        <!-- Chart 2: Lateness Trend -->
                        <div class="bg-white p-6 rounded-xl shadow-lg shadow-slate-200/50">
                            <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="line-chart" class="text-green-500"></i> Tren Keterlambatan (7 Hari Terakhir)</h3>
                            <div id="chart-trend-container" class="h-80">
                                 <div class="skeleton-loader w-full h-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Full Data & Chat Content -->
                <div id="content-data" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg shadow-slate-200/50">
                            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="book-open-text"></i> Detail Data Keterlambatan</h2>
                            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                                <table class="w-full text-sm text-left text-slate-600" id="data-table">
                                    <thead class="text-xs text-slate-50 uppercase bg-slate-700"></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg shadow-slate-200/50 flex flex-col h-[650px] lg:h-auto">
                            <div class="p-4 border-b border-slate-200"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="sparkles" class="text-violet-500"></i> Analis Data AI</h2></div>
                            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto"></div>
                            <div class="p-4 border-t border-slate-200">
                                <div class="flex items-center"><input type="text" id="chat-input" class="flex-grow border border-slate-300 rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tanya tentang data..."><button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2.5 rounded-r-lg flex items-center justify-center"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyCCjeeWBHSGGIMVmtSaUadLioZGL19f_VY'; 
        const SPREADSHEET_ID = '1kof1L9-mCbZiYKINeSXxk_zoBNDQkDlPW5zu-VwbiEc';
        const RANGE = 'Sheet1!A:F'; 

        // --- DOM ELEMENTS ---
        const currentDateEl = document.getElementById('current-date').querySelector('span');
        const navSummaryBtn = document.getElementById('nav-summary');
        const navDataBtn = document.getElementById('nav-data');
        const contentSummary = document.getElementById('content-summary');
        const contentData = document.getElementById('content-data');
        const tableHead = document.querySelector('#data-table thead');
        const tableBody = document.querySelector('#data-table tbody');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const downloadPdfBtn = document.getElementById('download-pdf');
        const searchInput = document.getElementById('search-input');

        // --- CHART & DATA STATE ---
        let allStudentData = [], currentFilteredData = [], currentHeaders = [], headerIndexMap = {};
        let processedAnalytics = {};
        let chartByClass, chartTrend;
        let activeTab = 'summary';

        // --- UTILITY FUNCTIONS ---
        const formatDate = (d) => new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const parseDate = (s) => { const [d, m, y] = s.split('/'); return new Date(y, m - 1, d); };

        // --- INITIALIZATION ---
        async function initializeApp() {
            lucide.createIcons();
            currentDateEl.textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            setupEventListeners();

            if (API_KEY.includes('YOUR_') || SPREADSHEET_ID.includes('YOUR_')) {
                handleError('Harap masukkan API Key dan Spreadsheet ID Anda di dalam kode.');
                return;
            }

            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
                if (!response.ok) throw new Error((await response.json()).error.message);
                const data = await response.json();
                const rows = data.values;

                if (!rows || rows.length < 2) {
                    handleError('Tidak ada data yang ditemukan di spreadsheet.');
                    return;
                }

                currentHeaders = rows[0];
                headerIndexMap = currentHeaders.reduce((acc, h, i) => ({ ...acc, [h.toLowerCase()]: i }), {});
                allStudentData = rows.slice(1).map(row => {
                    const fullRow = [...row];
                    while (fullRow.length < currentHeaders.length) fullRow.push('');
                    return fullRow;
                });
                
                currentFilteredData = [...allStudentData];

                processedAnalytics = processDataForAnalytics(allStudentData);
                
                renderAnalyticsDashboard(processedAnalytics);
                renderTable(currentFilteredData, currentHeaders);
                addChatMessage('Halo! Saya adalah analis data AI Anda. Tanyakan apa saja tentang data keterlambatan, misalnya "Siapa yang paling sering telat?" atau "Bandingkan keterlambatan kelas 10 dan 11".', 'bot');

            } catch (error) {
                console.error('Initialization Error:', error);
                handleError(`Gagal memuat data: ${error.message}`);
            }
        }

        function handleError(message) {
            document.getElementById('chart-by-class-container').innerHTML = `<p class="text-red-500 text-center p-4">${message}</p>`;
            document.getElementById('chart-trend-container').innerHTML = '';
            document.getElementById('leaderboard-container').innerHTML = '';
            showErrorInTable(message);
            addChatMessage(message, 'bot');
        }

        // --- DATA PROCESSING FOR ANALYTICS ---
        function processDataForAnalytics(data) {
            const byClass = {};
            const byDay = {};
            const byStudent = {};
            const today = new Date();
            const sevenDaysAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            data.forEach(row => {
                try {
                    const dateStr = row[headerIndexMap['tanggal']];
                    if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return; // Skip invalid date formats
                    
                    const date = parseDate(dateStr);
                    const studentName = row[headerIndexMap['nama']];
                    const studentClass = row[headerIndexMap['kelas']];

                    if (date >= startOfMonth) {
                        byClass[studentClass] = (byClass[studentClass] || 0) + 1;
                    }

                    if (date >= sevenDaysAgo) {
                        const dateKey = formatDate(date);
                        byDay[dateKey] = (byDay[dateKey] || 0) + 1;
                    }
                    
                    byStudent[studentName] = (byStudent[studentName] || 0) + 1;
                } catch (e) {
                    console.warn("Skipping row with invalid data:", row, e);
                }
            });

            const leaderboard = Object.entries(byStudent).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            const trendLabels = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(today.getDate() - i);
                return formatDate(d);
            }).reverse();

            const trendData = trendLabels.map(label => byDay[label] || 0);

            return { byClass, leaderboard, trendLabels, trendData };
        }

        // --- RENDERING ---
        function renderAnalyticsDashboard({ byClass, leaderboard, trendLabels, trendData }) {
            renderLatenessByClassChart(byClass);
            renderLeaderboard(leaderboard);
            renderLatenessTrendChart(trendLabels, trendData);
        }

        function renderLatenessByClassChart(data) {
            const container = document.getElementById('chart-by-class-container');
            container.innerHTML = '<canvas id="latenessByClassChart"></canvas>';
            const ctx = document.getElementById('latenessByClassChart').getContext('2d');
            if (chartByClass) chartByClass.destroy();
            chartByClass = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Jumlah Keterlambatan',
                        data: Object.values(data),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
            container.innerHTML = '';
            const list = document.createElement('ul');
            list.className = 'space-y-4';
            data.forEach(([name, count], index) => {
                const item = document.createElement('li');
                item.className = 'flex items-center';
                const medalColors = ['bg-amber-400', 'bg-slate-400', 'bg-yellow-600'];
                const medalColor = medalColors[index] || 'bg-slate-200 text-slate-600';
                item.innerHTML = `
                    <div class="flex-shrink-0 mr-4">
                        <span class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg text-white ${medalColor}">${index + 1}</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">${name}</p>
                        <p class="text-sm text-slate-500">${count} kali terlambat</p>
                    </div>
                    <div class="font-bold text-slate-700">${count}</div>
                `;
                list.appendChild(item);
            });
            container.appendChild(list);
        }

        function renderLatenessTrendChart(labels, data) {
            const container = document.getElementById('chart-trend-container');
            container.innerHTML = '<canvas id="latenessTrendChart"></canvas>';
            const ctx = document.getElementById('latenessTrendChart').getContext('2d');
            if (chartTrend) chartTrend.destroy();
            chartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Keterlambatan per Hari',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderColor: 'rgba(22, 163, 74, 1)',
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(22, 163, 74, 1)',
                        pointRadius: 4,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderTable(dataRows, headers) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            const headerRow = document.createElement('tr');
            headers.forEach(h => headerRow.innerHTML += `<th scope="col" class="px-6 py-3">${h}</th>`);
            tableHead.appendChild(headerRow);

            if (dataRows.length === 0) {
                showErrorInTable('Tidak ada data yang cocok.');
                return;
            }
            dataRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-slate-50 transition-colors';
                row.forEach((cell, index) => {
                    tr.innerHTML += `<td class="px-6 py-4 ${index === headerIndexMap['nama'] ? 'font-medium text-slate-900' : ''}">${cell}</td>`;
                });
                tableBody.appendChild(tr);
            });
        }
        
        function showErrorInTable(message) {
            tableBody.innerHTML = `<tr><td colspan="${currentHeaders.length || 6}" class="text-center p-8 text-red-500 bg-white">${message}</td></tr>`;
        }

        // --- AI CHAT FUNCTIONALITY ---
        async function handleChatSubmit() {
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            chatInput.value = '';
            addChatMessage('...', 'bot', true);

            try {
                const aiResponse = await getAiAction(userInput);
                
                switch(aiResponse.action) {
                    case "FILTER":
                        filterAndDisplayData(aiResponse.params);
                        updateLastBotMessage('Tentu, saya telah memfilter data di tabel sesuai permintaan Anda.');
                        break;
                    case "AGGREGATE":
                    case "INSIGHT":
                        const insightText = generateInsightText(aiResponse);
                        updateLastBotMessage(insightText);
                        break;
                    default:
                        updateLastBotMessage("Maaf, saya tidak yakin bagaimana merespons itu. Coba tanyakan tentang jumlah keterlambatan atau minta untuk memfilter data.");
                }

            } catch (error) {
                console.error('AI Error:', error);
                updateLastBotMessage('Maaf, terjadi kesalahan saat memproses permintaan Anda.');
            }
        }

        async function getAiAction(prompt) {
            const systemPrompt = `Anda adalah seorang analis data AI yang cerdas untuk sistem keterlambatan siswa. Tugas Anda adalah memahami permintaan pengguna dan mengubahnya menjadi salah satu dari tiga tindakan dalam format JSON: FILTER, AGGREGATE, atau INSIGHT.
            - Gunakan FILTER untuk menampilkan subset data di tabel (misal: "tampilkan kelas 10").
            - Gunakan AGGREGATE untuk menghitung data (misal: "berapa jumlah telat kelas 10?").
            - Gunakan INSIGHT untuk analisis lebih dalam (misal: "siapa paling sering telat?").
            Konteks: Hari ini adalah ${new Date().toLocaleDateString('id-ID')}. Kolom yang tersedia: ${currentHeaders.join(', ')}.`;

            const schema = {
                type: "OBJECT",
                properties: {
                    "action": { "type": "STRING", "enum": ["FILTER", "AGGREGATE", "INSIGHT"] },
                    "params": { 
                        "type": "OBJECT",
                        "properties": {
                            "filter_by": { "type": "STRING", "description": "Kolom untuk filter (nama, kelas, tanggal)"},
                            "filter_value": { "type": "STRING", "description": "Nilai untuk filter"},
                            "aggregate_type": { "type": "STRING", "description": "Tipe agregasi (COUNT, MOST_FREQUENT)"},
                            "insight_type": { "type": "STRING", "description": "Tipe insight (LEADERBOARD, TREND_COMPARISON)"}
                        }
                    }
                }
            };

            const payload = { contents: [{ role: "user", parts: [{ text: `${systemPrompt}\n\nPermintaan: "${prompt}"` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

            if (!response.ok) throw new Error(`API call failed: ${response.status}`);
            const result = await response.json();
            if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("No valid response from AI.");
            
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }
        
        function generateInsightText(aiResponse) {
            const { params } = aiResponse;
            if (params.aggregate_type === 'COUNT') {
                const filtered = allStudentData.filter(row => row[headerIndexMap[params.filter_by.toLowerCase()]].toLowerCase().includes(params.filter_value.toLowerCase()));
                return `Terdapat ${filtered.length} keterlambatan untuk ${params.filter_value}.`;
            }
            if (params.insight_type === 'LEADERBOARD' || params.aggregate_type === 'MOST_FREQUENT') {
                const topStudents = processedAnalytics.leaderboard.map(([name, count]) => `${name} (${count} kali)`).join('\n- ');
                return `Berikut adalah siswa yang paling sering terlambat:\n- ${topStudents}`;
            }
            return "Saya menemukan beberapa informasi menarik, tetapi saya tidak bisa menampilkannya saat ini.";
        }

        function filterAndDisplayData(filters) {
            if (!filters || !filters.filter_by || !filters.filter_value) {
                currentFilteredData = [...allStudentData];
            } else {
                const filterBy = filters.filter_by.toLowerCase();
                const filterValue = filters.filter_value.toLowerCase();
                const filterIndex = headerIndexMap[filterBy];
                if (filterIndex === undefined) {
                    addChatMessage(`Kolom "${filterBy}" tidak ditemukan.`, 'bot');
                    return;
                }
                currentFilteredData = allStudentData.filter(row => row[filterIndex].toLowerCase().includes(filterValue));
            }
            renderTable(currentFilteredData, currentHeaders);
        }
        
        function handleSearch(query) {
             const searchTerm = query.toLowerCase();
             const nameIndex = headerIndexMap['nama'];
             if (searchTerm === "") {
                 currentFilteredData = [...allStudentData];
             } else {
                 currentFilteredData = allStudentData.filter(row => row[nameIndex].toLowerCase().includes(searchTerm));
             }
             renderTable(currentFilteredData, currentHeaders);
             // Switch to data tab to show search results
             if (activeTab !== 'data') {
                 switchTab('data');
             }
        }

        function addChatMessage(text, sender, isThinking = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl max-w-md whitespace-pre-wrap shadow-sm ${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-800'}`;
            if (isThinking) {
                bubble.id = 'thinking-bubble';
                bubble.innerHTML = `<div class="flex items-center gap-1.5"><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div></div>`;
            } else {
                bubble.textContent = text;
            }
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateLastBotMessage(newText) {
            const thinkingBubble = document.getElementById('thinking-bubble');
            if (thinkingBubble) {
                thinkingBubble.innerHTML = '';
                thinkingBubble.textContent = newText;
                thinkingBubble.id = '';
            }
        }

        // --- UI & EVENT LISTENERS ---
        function setupEventListeners() {
            navSummaryBtn.addEventListener('click', (e) => { e.preventDefault(); switchTab('summary'); });
            navDataBtn.addEventListener('click', (e) => { e.preventDefault(); switchTab('data'); });
            sendButton.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keypress', e => e.key === 'Enter' && handleChatSubmit());
            downloadPdfBtn.addEventListener('click', handlePdfDownload);
            searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        }

        function switchTab(tabName) {
            activeTab = tabName;
            const summaryElements = [contentSummary, navSummaryBtn];
            const dataElements = [contentData, navDataBtn];

            if (tabName === 'summary') {
                summaryElements[0].classList.remove('hidden');
                dataElements[0].classList.add('hidden');
                summaryElements[1].classList.add('active');
                dataElements[1].classList.remove('active');
            } else {
                summaryElements[0].classList.add('hidden');
                dataElements[0].classList.remove('hidden');
                summaryElements[1].classList.remove('active');
                dataElements[1].classList.add('active');
            }
        }
        
        function handlePdfDownload() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const title = `Laporan Keterlambatan - ${new Date().toLocaleDateString('id-ID')}`;
            doc.setFontSize(18);
            doc.text(title, 14, 22);

            if (activeTab === 'summary' && chartByClass && chartTrend) {
                doc.setFontSize(14);
                doc.text("Ringkasan Analitik", 14, 32);
                try {
                    const chart1Img = chartByClass.toBase64Image();
                    const chart2Img = chartTrend.toBase64Image();
                    doc.setFontSize(11);
                    doc.text("Keterlambatan per Kelas (Bulan Ini)", 14, 40);
                    doc.addImage(chart1Img, 'PNG', 14, 45, 180, 90);
                    doc.text("Tren Keterlambatan (7 Hari Terakhir)", 14, 145);
                    doc.addImage(chart2Img, 'PNG', 14, 150, 180, 90);
                } catch(e) {
                    console.error("Error generating chart images for PDF:", e);
                    doc.text("Gagal membuat gambar grafik.", 14, 45);
                }
            } else {
                doc.autoTable({
                    head: [currentHeaders],
                    body: currentFilteredData,
                    startY: 30,
                    theme: 'grid',
                    styles: { font: 'Inter', fontSize: 8 },
                    headStyles: { fillColor: [41, 51, 65] }
                });
            }
            doc.save(`Laporan_Keterlambatan_${Date.now()}.pdf`);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
